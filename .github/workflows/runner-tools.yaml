name: Update Runner Tools Lock

on:
  schedule:
    - cron: 0 6 * * *
  workflow_dispatch:

jobs:

  collect:
    strategy:
      matrix:
        runner:
          - macos-15
          - macos-15-intel
          - ubuntu-22.04
          - ubuntu-22.04-arm
    runs-on: ${{ matrix.runner }}
    steps:

      - name: Collect
        shell: bash
        run: |-
          set -euo pipefail

          case "$RUNNER_OS/$RUNNER_ARCH" in
            Linux/ARM64) system=aarch64-linux ;;
            Linux/X64)   system=x86_64-linux ;;
            macOS/ARM64) system=aarch64-darwin ;;
            macOS/X64)   system=x86_64-darwin ;;
            *) echo >&2 "unsupported: $RUNNER_OS/$RUNNER_ARCH"; exit 1 ;;
          esac

          image_key="$ImageOS/$ImageVersion"

          if [[ $RUNNER_OS == Linux ]]; then
            state_hash=$(sha256sum /var/lib/dpkg/status | awk '{print $1}')
          else
            state_hash=$(brew list --versions | shasum --algorithm 256 | awk '{print $1}')
          fi

          jq \
            --null-input \
            --arg system "$system" \
            --arg image_key "$image_key" \
            --arg state_hash "$state_hash" \
            '{($system): {($image_key): {stateHash: $state_hash}}}' \
            > fragment.json

      - uses: actions/upload-artifact@v4
        with:
          name: lock-${{ matrix.runner }}
          path: fragment.json

  commit:
    needs: collect
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:

      - uses: actions/checkout@v6

      - uses: actions/download-artifact@v4
        with:
          path: fragments

      - name: Merge
        id: merge
        run: |-
          set -euo pipefail

          # deep-merge all per-system fragments into one object
          jq \
            --null-input \
            '[inputs] | reduce .[] as $f ({}; . * $f)' \
            fragments/*/fragment.json > merged.json

          # validate: within each OS family (linux/darwin) all systems must
          # share the same image_key; extract keys for the commit message
          image_keys=$(jq --raw-output '
            to_entries
            | group_by(.key | split("-") | last)
            | map(
                (map(.value | keys[0]) | unique) as $keys |
                if ($keys | length) > 1 then
                  error("inconsistent image_key within OS family: \($keys | @json)")
                else $keys[0] end
              )
            | unique
            | join(", ")
          ' merged.json)
          echo "image_keys=$image_keys" >> "$GITHUB_OUTPUT"

          if [[ -f runner-tools.lock ]]; then
            # for each system in the new data: merge with existing entries,
            # sort by image key descending, keep the 10 most recent
            jq \
              --slurpfile new merged.json '
                reduce ($new[0] | to_entries[]) as $sys (
                  .;
                  .[$sys.key] = (
                    (.[$sys.key] // {}) + $sys.value
                    | to_entries
                    | sort_by(.key)
                    | reverse
                    | .[0:10]
                    | from_entries
                  )
                )
              ' runner-tools.lock > tmp.json
          else
            cp merged.json tmp.json
          fi

          mv tmp.json runner-tools.lock

      - uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore(ci): update runner tools lock [${{ steps.merge.outputs.image_keys }}]"
          file_pattern: runner-tools.lock
