#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Usage: sync-ci-envs --provider gitlab|circleci|appveyor --repo OWNER/REPO \
  --var NAME [--var NAME ...] [--gitlab-project-id ID] \
  [--appveyor-account ACCOUNT] [--appveyor-slug SLUG]

Environment:
  GITLAB_API_TOKEN   GitLab personal access token (api scope)
  CIRCLECI_TOKEN     CircleCI API token
  APPVEYOR_TOKEN     AppVeyor API token

Notes:
  - Values are read from the current environment for each --var NAME.
  - AppVeyor writes plain (non-secured) variables; use the UI for secrets.
EOF
}

provider=""
repo=""
gitlab_project_id=""
appveyor_account=""
appveyor_slug=""
vars=()

while [ $# -gt 0 ]; do
  case "$1" in
  --provider)
    provider="$2"
    shift 2
    ;;
  --repo)
    repo="$2"
    shift 2
    ;;
  --gitlab-project-id)
    gitlab_project_id="$2"
    shift 2
    ;;
  --appveyor-account)
    appveyor_account="$2"
    shift 2
    ;;
  --appveyor-slug)
    appveyor_slug="$2"
    shift 2
    ;;
  --var)
    vars+=("$2")
    shift 2
    ;;
  -h | --help)
    usage
    exit 0
    ;;
  *)
    echo "Unknown argument: $1" >&2
    usage >&2
    exit 1
    ;;
  esac
done

if [ -z "$provider" ] || [ -z "$repo" ] || [ ${#vars[@]} -eq 0 ]; then
  usage >&2
  exit 1
fi

require_value() {
  local name="$1"
  local value="${!name-}"
  if [ -z "$value" ]; then
    echo "Missing value for $name in environment" >&2
    exit 1
  fi
  printf '%s' "$value"
}

sync_gitlab() {
  if [ -z "${GITLAB_API_TOKEN-}" ] || [ -z "$gitlab_project_id" ]; then
    echo "gitlab requires GITLAB_API_TOKEN and --gitlab-project-id" >&2
    exit 1
  fi
  project_url="https://gitlab.com/api/v4/projects/${gitlab_project_id}"
  for name in "${vars[@]}"; do
    value="$(require_value "$name")"
    url="${project_url}/variables/${name}"
    if ! curl --silent --fail --show-error \
      --request PUT \
      --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
      --data-urlencode "value=${value}" \
      --data "protected=false" \
      --data "masked=false" \
      "$url" >/dev/null; then
      curl --silent --fail --show-error \
        --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
        --data "key=${name}" \
        --data-urlencode "value=${value}" \
        --data "protected=false" \
        --data "masked=false" \
        "${project_url}/variables" \
        >/dev/null
    fi
    echo "synced gitlab:${name}"
  done
}

sync_circleci() {
  if [ -z "${CIRCLECI_TOKEN-}" ]; then
    echo "circleci requires CIRCLECI_TOKEN" >&2
    exit 1
  fi
  for name in "${vars[@]}"; do
    value="$(require_value "$name")"
    escaped_value="${value//\\/\\\\}"
    escaped_value="${escaped_value//\"/\\\"}"
    curl --silent --fail --show-error \
      --request POST \
      --url "https://circleci.com/api/v2/project/gh/${repo}/envvar" \
      --header "Circle-Token: ${CIRCLECI_TOKEN}" \
      --header "Content-Type: application/json" \
      --data "{\"name\":\"${name}\",\"value\":\"${escaped_value}\"}" \
      >/dev/null
    echo "synced circleci:${name}"
  done
}

sync_appveyor() {
  if [ -z "${APPVEYOR_TOKEN-}" ] ||
    [ -z "$appveyor_account" ] ||
    [ -z "$appveyor_slug" ]; then
    echo "appveyor requires APPVEYOR_TOKEN, account, and slug" >&2
    exit 1
  fi
  for name in "${vars[@]}"; do
    value="$(require_value "$name")"
    url="https://ci.appveyor.com/api/projects/${appveyor_account}/""\
${appveyor_slug}/settings/environment-variables"
    curl --silent --fail --show-error \
      --request POST \
      --url "$url" \
      --header "Authorization: Bearer ${APPVEYOR_TOKEN}" \
      --header "Content-Type: application/json" \
      --data @- <<EOF
{"name":"${name}","value":"${value}","isSecured":false}
EOF
    echo "synced appveyor:${name}"
  done
}

case "$provider" in
gitlab)
  sync_gitlab
  ;;
circleci)
  sync_circleci
  ;;
appveyor)
  sync_appveyor
  ;;
*)
  echo "Unsupported provider: $provider" >&2
  exit 1
  ;;
esac
